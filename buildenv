# bump: hlasm_language_server-version /HLASM_LANGUAGE_SERVER_VERSION="(.*)"/ https://github.com/eclipse-che4z/che-che4z-lsp-for-hlasm.git|semver:*
HLASM_LANGUAGE_SERVER_VERSION="1.21.0"

###
### Build control file for the hlasm_language_server port
###

export ZOPEN_NAME="HLASM_LANGUAGE_SERVER_VERSION"
export ZOPEN_CATEGORIES="development"

export ZOPEN_RUNTIME_DEPS=""

###
### Required Environment Variables
###
export ZOPEN_BUILD_LINE="STABLE"

export ZOPEN_STABLE_URL="https://github.com/eclipse-che4z/che-che4z-lsp-for-hlasm.git"
export ZOPEN_STABLE_TAG="1.20.0"
export ZOPEN_STABLE_DEPS="cmake make ninja ccache boost"

export ZOPEN_DEV_URL="https://github.com/eclipse-che4z/che-che4z-lsp-for-hlasm.git"
export ZOPEN_DEV_DEPS="cmake make ninja ccache boost"
export ZOPEN_DEV_BRANCH="development"
# export ZOPEN_SYSTEM_PREREQ="zos25" # optional system pre-req (default=zos25)


###
### Build settings (Port type: BUILD, Build system: CMake)
###
### Settings for CMake build system
export ZOPEN_CONFIGURE="cmake"
export ZOPEN_CONFIGURE_OPTS="-B ../build \
  -DCMAKE_INSTALL_PREFIX=\${ZOPEN_INSTALL_DIR} \
  -DDISCOVER_TESTS=OFF \
  -DBUILD_TESTING=OFF \
  -DBUILD_VSIX=OFF "

export ZOPEN_MAKE="zopen_build"
# export ZOPEN_MAKE="cmake"
# export ZOPEN_MAKE_OPTS="--build ../build"
export ZOPEN_INSTALL="cmake"
export ZOPEN_INSTALL_OPTS="--install ../build"
# ZOPEN_CHECK is often 'ctest' or a custom function.
#export ZOPEN_CHECK="ctest"
#export ZOPEN_CHECK_OPTS="--test-dir ../build --output-on-failure"


###
### Required user-supplied functions
###

apply_patch() {
    patch_file="$1"

    if [ -z "$patch_file" ]; then
        echo "Error: No patch file specified ${patch_file}.."
        return 1
    fi

    git apply "$patch_file"
    if [ $? -ne 0 ]; then
        echo "Error: git apply failed for $patch_file"
        return 1
    fi
}

zopen_build()
{
  echo "In ZOPEN_BUILD, applying patches to build/_deps/boost_ext-src"

  cd ../build/_deps/boost_ext-src
  if ! apply_patch "$ZOPEN_ROOT/asio-patches/config.hpp.patch"; then return 1; fi
  if ! apply_patch "$ZOPEN_ROOT/asio-patches/signal_set_base.hpp.patch"; then return 1; fi
  if ! apply_patch "$ZOPEN_ROOT/asio-patches/socket_option.hpp.patch"; then return 1; fi
  if ! apply_patch "$ZOPEN_ROOT/asio-patches/socket_types.hpp.patch"; then return 1; fi
  if ! apply_patch "$ZOPEN_ROOT/asio-patches/unicast.hpp.patch"; then return 1; fi
  if ! apply_patch "$ZOPEN_ROOT/asio-patches/posix_event.ipp.patch"; then return 1; fi
  cd -

  echo "Starting the actual build process"

  cmake --build ../build -- -j $ZOPEN_NUM_JOBS
}

zopen_check_results() {
  dir="$1" 
  pfx="$2" 
  chk="$1/$2_check.log"
  # Add logic to extract the test results here:
  echo "actualFailures:0" 
  echo "totalTests:1" 
  echo "expectedFailures:0"
  echo "expectedTotalTests:1"
}

zopen_get_version() {
  echo "$HLASM_LANGUAGE_SERVER_VERSION"
}


###
### Custom Build Logic (if applicable)
###
# For libraries, this hook exports variables for other ports to use.
#zopen_append_to_env() {
#  cat <<END
#if [ ! -z "\$ZOPEN_IN_ZOPEN_BUILD" ]; then
#  export ZOPEN_EXTRA_CFLAGS="\${ZOPEN_EXTRA_CFLAGS} -I\${PWD}/include"
#  export ZOPEN_EXTRA_CXXFLAGS="\${ZOPEN_EXTRA_CXXFLAGS} -I\${PWD}/include"
#  export ZOPEN_EXTRA_LDFLAGS="\${ZOPEN_EXTRA_LDFLAGS} -L\${PWD}/lib"
#  export ZOPEN_EXTRA_LIBS="\${ZOPEN_EXTRA_LIBS} -lhlasm_language_server"
#fi
#END
#}

###
### Optional User-Supplied Hooks (uncomment to use)
###

#zopen_append_to_env() {
#  ## This function runs as part of generation of the .env file. The output of the
#  ## function is appended to .env.
#}
#
#zopen_append_to_setup(){
#  ## This function runs as part of generation of the setup.sh file. The output of
#  ## the function is appended to setup.sh.
#}
#
#zopen_append_to_validate_install(){
#  ## This function runs as part of generation of the install_test.sh file. The
#  ## output of the function is appended to install_test.sh script.
#}
#
#zopen_install_caveats(){
#  ## This function is run post install. All stdout messages are captured and
#  ## added to the metadata.json as installation caveats.
#}
#
#zopen_init(){
#  ## This function runs after code is downloaded and patched but before the code
#  ## is built.
#}
#
#zopen_post_buildenv(){
#  ## This function runs after the 'buildenv' is processed.
#}
#
#zopen_pre_build(){
#  ## This function runs before the 'make' step of the build is run.
#}
#
#zopen_pre_check(){
#  ## This function runs before the 'check' step of the build is run.
#}
#
#zopen_pre_configure(){
#  ## This function runs before the 'configure' step of the build is run.
#}
#
#zopen_pre_install(){
#  ## This function runs before the 'install' step of the build is run.
#}
#
#zopen_post_install(){
#  ## This function runs after the 'install' step of the build is run.
#}
#
#zopen_pre_patch(){
#  ## This function runs before the 'patch' step of the build is run.
#}
#
#zopen_pre_terminate(){
#  ## This function runs before 'zopen build' terminates.
#}

